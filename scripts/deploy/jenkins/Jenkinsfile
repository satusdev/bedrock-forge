pipeline {
    agent any
    environment {
        REMOTE_USER = 'your_cyberpanel_user'
        REMOTE_HOST = 'your.cyberpanel.server'
        REMOTE_PATH = '/home/your_cyberpanel_user/public_html'
        SITE_NAME = 'bedrock-site'
        SLACK_WEBHOOK = 'your_slack_webhook_id'
    }
    stages {
        stage('Build') {
            steps {
                sh 'ddev composer install --no-dev --optimize-autoloader'
            }
        }
        stage('Test') {
            steps {
                sh 'ddev exec vendor/bin/phpunit'
            }
        }
        stage('Deploy') {
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: 'jenkins-cyberpanel', keyFileVariable: 'SSH_KEY', usernameVariable: 'SSH_USR')]) {
                    sh '''
                        echo "Sync Bedrock files to CyberPanel server..."
                        rsync -az --delete --exclude ".env" --exclude ".git/" --exclude "node_modules/" --exclude ".DS_Store" \
                          -e "ssh -i $SSH_KEY -o StrictHostKeyChecking=no" ./web/ $REMOTE_USER@$REMOTE_HOST:$REMOTE_PATH/

                        echo "Run WP-CLI commands remotely (optional)..."
                        ssh -i $SSH_KEY -o StrictHostKeyChecking=no $REMOTE_USER@$REMOTE_HOST "cd $REMOTE_PATH && wp core update && wp plugin update --all"
                    '''
                }
            }
        }
    }
    post {
        always {
            cleanWs()
        }
        success {
            script {
                slackSend(
                    webhookCredentialId: env.SLACK_WEBHOOK,
                    channel: '#ci-cd',
                    color: 'good',
                    message: "‚úÖ SUCCESS: `${env.JOB_NAME}` #${env.BUILD_NUMBER} deployed Bedrock to CyberPanel.\nüîó <${env.BUILD_URL}|Open Build>"
                )
            }
        }
        failure {
            script {
                slackSend(
                    webhookCredentialId: env.SLACK_WEBHOOK,
                    channel: '#ci-cd',
                    color: 'danger',
                    message: "‚ùå FAILED: `${env.JOB_NAME}` #${env.BUILD_NUMBER} failed Bedrock deployment.\nüîó <${env.BUILD_URL}|Open Build>"
                )
            }
        }
        unstable {
            script {
                slackSend(
                    webhookCredentialId: env.SLACK_WEBHOOK,
                    channel: '#ci-cd',
                    color: 'warning',
                    message: "‚ö†Ô∏è UNSTABLE: `${env.JOB_NAME}` #${env.BUILD_NUMBER} unstable Bedrock deployment.\nüîó <${env.BUILD_URL}|Open Build>"
                )
            }
        }
    }
}
